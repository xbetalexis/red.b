<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>RED-B CASINO</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;800&display=swap" rel="stylesheet">

<style>
body{
  background:radial-gradient(circle at top,#2a0000,#000 65%);
  font-family:'Orbitron',sans-serif;
  color:white;
  margin:0;
  padding:0;
  text-align:center;
}

h1{
  font-size:38px;
  color:#ff0000;
  margin-top:25px;
  text-shadow:
    0 0 5px #fff,
    0 0 15px #ff0000,
    0 0 30px #ff0000;
  animation:latido 1.3s infinite;
}

@keyframes latido{
  0%,100%{transform:scale(1)}
  50%{transform:scale(1.07)}
}

#contenedor{
  margin:140px auto 40px;
  max-width:420px;
  padding:30px;
  border-radius:20px;
  background:rgba(0,0,0,0.5);
  box-shadow:0 0 25px #000;
}

input{
  padding:12px;
  width:85%;
  font-size:16px;
  border-radius:10px;
  border:none;
  text-align:center;
}

button{
  margin-top:20px;
  padding:14px 28px;
  font-size:18px;
  background:#ff2b2b;
  border:none;
  border-radius:100px;
  cursor:pointer;
  color:#fff;
  box-shadow:0 0 15px #000;
}

button:disabled{
  background:#444;
  cursor:not-allowed;
}

#resultado{
  margin-top:20px;
  font-size:18px;
  min-height:30px;
}

.resultado-exito{color:#00ff55}
.resultado-sinpremio{color:#ff3b3b}
.resultado-aviso{color:#ffaa00}
.resultado-error{color:#ff0000}

#botonRecargar{
  display:none;
  margin-top:25px;
  padding:10px 22px;
  background:#222;
  color:#ff2b2b;
  border:2px solid #ff2b2b;
  border-radius:30px;
  cursor:pointer;
}
</style>
</head>

<body>

<h1>RED-B CASINO</h1>

<div id="contenedor">
  <input id="codigo" placeholder="Ingres√° tu c√≥digo"/>
  <br>
  <button id="botonTirar" onclick="tirar()">üé∞ PROBAR SUERTE</button>

  <div id="resultado"></div>

  <button id="botonRecargar" onclick="location.reload()">
    üëâ Presion√° ac√° para colocar otro c√≥digo
  </button>
</div>

<script>
// ====== STORAGE CORRECTO (EL QUE FUNCIONABA) ======
const usados = JSON.parse(localStorage.getItem("usados") || "{}");

function setFirstUse(codigo){
  const key = `firstUsed_${codigo}`;
  if(!localStorage.getItem(key)){
    localStorage.setItem(key,new Date().toISOString());
  }
}

function getFirstUse(codigo){
  return localStorage.getItem(`firstUsed_${codigo}`);
}

function formatFecha(iso){
  const d = new Date(iso);
  const pad = n => String(n).padStart(2,"0");
  return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

// ====== FUNCION CLAVE ======
function tirar(){
  const codigoInput = document.getElementById("codigo");
  const boton = document.getElementById("botonTirar");
  const resultado = document.getElementById("resultado");
  const botonRecargar = document.getElementById("botonRecargar");
  const codigo = codigoInput.value.trim();

  if(!codigo){
    resultado.className="resultado-aviso";
    resultado.innerText="‚ö†Ô∏è Ingres√° un c√≥digo.";
    return;
  }

  // üîí BLOQUEO REAL (ANTES DE LA API)
  if(usados[codigo]){
    const first = getFirstUse(codigo);
    resultado.className="resultado-aviso";
    resultado.innerHTML =
      `üö´ Ya usaste este c√≥digo en este dispositivo.<br>` +
      `üïí Primera vez: <b>${formatFecha(first)}</b>`;
    boton.disabled=true;
    return;
  }

  fetch("/api/verificar-codigo",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ codigo })
  })
  .then(r=>r.json())
  .then(data=>{
    if(data.estado==="valido"){
      const msg = (data.mensaje||"").toLowerCase();
      if(msg.includes("sin premio")){
        resultado.className="resultado-sinpremio";
        resultado.innerText="‚ùå SIN PREMIO ‚Äì PROB√Å EN TU PR√ìXIMA CARGA";
      }else{
        resultado.className="resultado-exito";
        resultado.innerText="‚úÖ "+data.mensaje;
      }
      usados[codigo]=true;
      localStorage.setItem("usados",JSON.stringify(usados));
      setFirstUse(codigo);

    }else if(data.estado==="usado"){
      resultado.className="resultado-aviso";
      resultado.innerText="üö´ Este c√≥digo ya fue utilizado.";
    }else{
      resultado.className="resultado-error";
      resultado.innerText="‚ùå C√≥digo inv√°lido.";
    }

    codigoInput.disabled=true;
    boton.disabled=true;
    botonRecargar.style.display="inline-block";
  })
  .catch(()=>{
    resultado.className="resultado-error";
    resultado.innerText="‚ùå Error al verificar.";
    boton.disabled=true;
    botonRecargar.style.display="inline-block";
  });
}
</script>

</body>
</html>
